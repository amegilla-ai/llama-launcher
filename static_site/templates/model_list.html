<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Model Launcher</title>
  <link rel="stylesheet" href="{{ css_url }}">
</head>
<body>
<div class="container">
  <h1>Model Launcher</h1>
  <p style="color: var(--muted); margin-bottom: 2rem; line-height: 1.6;">
    Click the clipboard icons to copy launch commands to your clipboard. Each model shows 4 command variations: 
    <strong>GPU Server</strong>, <strong>CPU Server</strong>, <strong>GPU CLI</strong>, and <strong>CPU CLI</strong>. 
    Choose the appropriate command based on your hardware and usage needs.
  </p>

  {% if llama_server_commands %}
  <div class="server-commands">
    <h3>Commands for llama-server UI with dynamic model loading</h3>
    
    <div class="command-section">
      <label><strong>GPU Server (INI Only):</strong></label>
      <div class="command-input-group">
        <input type="text" value="{{ llama_server_commands.gpu }}" readonly id="gpuCmd" class="command-input">
        <button onclick="copyCommand('gpuCmd')" class="copy-btn">Copy</button>
      </div>
    </div>
    
    <div class="command-section">
      <label><strong>CPU Server (INI Only):</strong></label>
      <div class="command-input-group">
        <input type="text" value="{{ llama_server_commands.cpu }}" readonly id="cpuCmd" class="command-input">
        <button onclick="copyCommand('cpuCmd')" class="copy-btn">Copy</button>
      </div>
    </div>
    
    <div class="command-section">
      <label><strong>GPU Server (INI + Folder):</strong></label>
      <div class="command-input-group">
        <input type="text" value="{{ llama_server_commands.gpu }} --models-dir {{ models_dir }}" readonly id="gpuFolderCmd" class="command-input">
        <button onclick="copyCommand('gpuFolderCmd')" class="copy-btn">Copy</button>
      </div>
    </div>
    
    <div class="command-section">
      <label><strong>CPU Server (INI + Folder):</strong></label>
      <div class="command-input-group">
        <input type="text" value="{{ llama_server_commands.cpu }} --models-dir {{ models_dir }}" readonly id="cpuFolderCmd" class="command-input">
        <button onclick="copyCommand('cpuFolderCmd')" class="copy-btn">Copy</button>
      </div>
    </div>
  </div>

  <style>
  .server-commands {
    margin: 20px 0;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: #f9f9f9;
  }

  .server-commands h3 {
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .command-section {
    margin: 10px 0;
  }

  .command-input-group {
    display: flex;
    gap: 10px;
    margin-top: 5px;
  }

  .command-input {
    flex: 1;
    padding: 8px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: white;
  }

  .copy-btn {
    padding: 8px 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    transition: background 0.3s;
    white-space: nowrap;
  }

  .copy-btn:hover {
    background: #0056b3;
  }

  .copy-btn:active {
    transform: scale(0.98);
  }
  </style>
  {% endif %}

  {% if not model_groups %}
    <p class="empty">No models found.</p>
  {% else %}
    {% for directory, models in model_groups.items() %}
      <section class="group">
        <h2 class="group-title">{{ directory }} ({{ models|length }})</h2>

        {% for m in models %}
          <article class="model-card">
            <header class="model-header">
              <strong class="model-name">
                {{ m.model_name }}
                {% if m.include_in_ini %}
                <span style="background:#10b981; color:white; font-size:.7rem; padding:.2rem .4rem; border-radius:4px; margin-left:.5rem;">INI</span>
                {% endif %}
              </strong>
              <span class="size">{{ m.file_size }}</span>
            </header>
            <p class="path">{{ m.model_path }}</p>

            <!-- --------------------------------------------------------
                 Command blocks – 4 combinations: GPU/CPU × Server/CLI
                 -------------------------------------------------------- -->
            <div class="cmd-blocks">
              {% for mode in ["gpu","cpu"] %}
                {% for bin in ["server","cli"] %}
                  {# Select the appropriate binary based on mode and type #}
                  {% if bin == "server" and mode == "gpu" %}
                    {% set binary_path = SERVER_GPU_BIN %}
                  {% elif bin == "server" and mode == "cpu" %}
                    {% set binary_path = SERVER_CPU_BIN %}
                  {% elif bin == "cli" and mode == "gpu" %}
                    {% set binary_path = CLI_GPU_BIN %}
                  {% else %}
                    {% set binary_path = CLI_CPU_BIN %}
                  {% endif %}
                  
                  {# Build parameter string from common + specific sections #}
                  {% set param_parts = [] %}
                  
                  {# Add common parameters #}
                  {% for key, values in m.params.common.items() %}
                    {% set value = values[mode] %}
                    {% if value %}
                      {% set _ = param_parts.append(key + " " + value) %}
                    {% else %}
                      {% set _ = param_parts.append(key) %}
                    {% endif %}
                  {% endfor %}
                  
                  {# Add section-specific parameters (server or cli) #}
                  {% for key, values in m.params[bin].items() %}
                    {% set value = values[mode] %}
                    {% if value %}
                      {% set _ = param_parts.append(key + " " + value) %}
                    {% else %}
                      {% set _ = param_parts.append(key) %}
                    {% endif %}
                  {% endfor %}
                  
                  {% set param_str = param_parts|join(' ') %}
                  {% set full_cmd = binary_path + " -m " + m.model_path + " " + param_str %}
                  {% set unique_id = "cmd_" ~ directory|replace('/', '_')|replace(' ', '_') ~ "_" ~ loop.index0 ~ "_" ~ m.model_name|replace('.', '_')|replace(' ', '_') ~ "_" ~ mode ~ "_" ~ bin %}

                  <div class="cmd-row">
                    <span class="cmd-label">{{ mode|upper }} {{ bin }}</span>
                    <button class="copy-btn" data-cmd="{{ full_cmd }}" aria-label="Copy command">
                    <svg viewBox="0 0 24 24"><use href="#copy-icon"/></svg>
                    </button>
                    <code class="cmd">{{ full_cmd }}</code>
                  </div>
                {% endfor %}
              {% endfor %}
            </div>

          </article>
        {% endfor %}
      </section>
    {% endfor %}
  {% endif %}
</div>

<!-- Inline copy-icon sprite -->
<svg style="display:none;">
  <symbol id="copy-icon" viewBox="0 0 24 24">
    <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z"/>
  </symbol>
</svg>


<script>
// For server commands (input fields)
function copyCommand(elementId) {
  const input = document.getElementById(elementId);
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(input.value).then(() => {
      const btn = input.nextElementSibling;
      const originalText = btn.textContent;
      btn.textContent = '✓ Copied!';
      btn.style.background = '#28a745';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
    });
  }
}

// For model commands - same as your copy.js
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.copy-btn[data-cmd]').forEach(btn => {
    btn.addEventListener('click', () => {
      const cmd = btn.getAttribute('data-cmd');
      navigator.clipboard.writeText(cmd).then(() => {
        const svg = btn.querySelector('svg');
        const original = btn.innerHTML;
        btn.innerHTML = '✓';
        btn.style.background = '#28a745';
        setTimeout(() => {
          btn.innerHTML = original;
          btn.style.background = '';
        }, 2000);
      });
    });
  });
});
</script>
</body>
</html>